<!DOCTYPE html>
<html>
<head>
  <title>ระบบรายงานพิกัด</title>
  <meta charset="utf-8" />
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }
    #map {
      height: 400px;
      width: 100%;
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-top: 10px;
    }
    input, select, textarea {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
    }
    button {
      margin-top: 15px;
      padding: 10px 20px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <h1>ระบบรายงานพิกัดหน้างาน</h1>

  <div id="map"></div>

  <form id="reportForm">
    <label>ชื่อผู้รายงาน:
      <input type="text" id="name" required>
    </label>

    <label>ปัญหา:
      <select id="issue" required>
        <option value="">-- เลือกปัญหา --</option>
        <option value="น้ำท่วม">น้ำท่วม</option>
        <option value="รก">รก</option>
      </select>
    </label>

    <label>แนบรูปภาพ:
      <input type="file" id="photo" accept="image/*">
    </label>

    <label>ละติจูด:
      <input type="text" id="lat" readonly>
    </label>

    <label>ลองจิจูด:
      <input type="text" id="lng" readonly>
    </label>

    <button type="submit">ส่งรายงาน</button>
  </form>

  <p id="status"></p>

  <script>
    let map, marker;

    function initMap() {
      // ใช้ตำแหน่งปัจจุบัน
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((position) => {
          const pos = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };
          map = new google.maps.Map(document.getElementById("map"), {
            center: pos,
            zoom: 16
          });
          marker = new google.maps.Marker({
            position: pos,
            map: map,
            draggable: true
          });
          document.getElementById("lat").value = pos.lat;
          document.getElementById("lng").value = pos.lng;

          marker.addListener("dragend", () => {
            const pos = marker.getPosition();
            document.getElementById("lat").value = pos.lat();
            document.getElementById("lng").value = pos.lng();
          });
        }, () => {
          alert("ไม่สามารถดึงตำแหน่งได้");
        });
      }
    }

    document.getElementById("reportForm").addEventListener("submit", async function(e) {
      e.preventDefault();

      const name = document.getElementById("name").value;
      const issue = document.getElementById("issue").value;
      const lat = document.getElementById("lat").value;
      const lng = document.getElementById("lng").value;

      const photoInput = document.getElementById("photo");
      let photoBase64 = "";
      if (photoInput.files.length > 0) {
        const file = photoInput.files[0];
        const reader = new FileReader();
        reader.onload = async function(event) {
          photoBase64 = event.target.result;

          await sendData(name, issue, lat, lng, photoBase64);
        };
        reader.readAsDataURL(file);
      } else {
        await sendData(name, issue, lat, lng, "");
      }
    });

    async function sendData(name, issue, lat, lng, photo) {
      const url = "https://script.google.com/macros/s/AKfycbyrbn_OIkxbz-X32zuV9QNJkzD6J6LnZ25iqeQVse1oDvvdS-wB7Fw-EK6ASC8dZnZQ/exec";

      const data = {
        name,
        issue,
        lat,
        lng,
        photo
      };

      try {
        const response = await fetch(url, {
          method: "POST",
          mode: "no-cors", // สำหรับ Bypass CORS (Google Sheets ไม่ตอบกลับ)
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(data)
        });

        document.getElementById("status").textContent = "ส่งข้อมูลเรียบร้อยแล้ว ✅";
        document.getElementById("reportForm").reset();
      } catch (error) {
        document.getElementById("status").textContent = "เกิดข้อผิดพลาด ❌";
        console.error(error);
      }
    }
  </script>

  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDo19Y656oPz9kcU7qsnjraw8IgmTpkjm4&callback=initMap" async defer></script>
</body>
</html>